AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  DomainName:
    Type: String
    Default: flashcards.aws-sensei.cloud
  HostedZoneId:
    Type: String
    Description: The Route 53 hosted zone ID for aws-sensei.cloud
    Default: Z0003192F8JJC6RWXV1M
  CertificateArn:
    Type: String
    Description: ACM certificate ARN for the domain (must be in us-east-1)
    Default: arn:aws:acm:us-east-1:804711834430:certificate/6ac27f6a-b570-4111-8687-1c6113bd1f49

Resources:
  #
  # DynamoDB table for flashcards
  #
  FlashcardsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Flashcards
      BillingMode: PAY_PER_REQUEST

      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: card_type
          AttributeType: S
        - AttributeName: career
          AttributeType: S
        # - AttributeName: subject
        #   AttributeType: S
        # - AttributeName: subject_career
        #   AttributeType: S

      KeySchema:
        - AttributeName: id
          KeyType: HASH
        - AttributeName: card_type
          KeyType: RANGE

      GlobalSecondaryIndexes:
        - IndexName: CareerIndex
          KeySchema:
            - AttributeName: career
              KeyType: HASH
            - AttributeName: card_type
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # - IndexName: SubjectIndex
        #   KeySchema:
        #     - AttributeName: subject
        #       KeyType: HASH
        #     - AttributeName: card_type
        #       KeyType: RANGE
        #   Projection:
        #     ProjectionType: ALL
        # - IndexName: SubjectCareerIndex
        #   KeySchema:
        #     - AttributeName: subject_career
        #       KeyType: HASH
        #     - AttributeName: card_type
        #       KeyType: RANGE
        #   Projection:
        #     ProjectionType: ALL

      SSESpecification:
        SSEEnabled: true
        
  #
  # Cognito User Pool (private users)
  #
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub flashcards-userpool
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: false
          RequireSymbols: false
          RequireUppercase: false
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub flashcards-client
      GenerateSecret: false
      UserPoolId: !Ref UserPool
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      
  #
  # HTTP API (HTTP API v2) with Cognito JWT Authorizer
  #
  FlashcardsApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      Name: !Sub flashcards-httpapi
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - GET
          - POST
          - OPTIONS
        AllowHeaders:
          - Authorization
          - Content-Type
          - X-Amz-Date
          - X-Api-Key
          - X-Amz-Security-Token
          - X-Amz-User-Agent
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            JwtConfiguration:
              Audience:
                - !Ref UserPoolClient
              Issuer: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}
            IdentitySource: "$request.header.Authorization"
                      
  #
  # API Lambda - business logic: GET /items/random, GET /items/{id}/answer
  #
  ApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub flashcards-api
      CodeUri: src/api/
      Handler: app.lambda_handler
      Runtime: python3.14
      Environment:
        Variables:
          TABLE_NAME: !Ref FlashcardsTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
                - dynamodb:BatchGetItem
                - dynamodb:Scan
              Resource:
                - !GetAtt FlashcardsTable.Arn
                - !Sub "${FlashcardsTable.Arn}/index/*"
      Events:
        GetItem:
          Type: HttpApi
          Properties:
            Path: /items/random
            Method: GET
            ApiId: !Ref FlashcardsApi
            Auth:
              Authorizer: CognitoAuthorizer
        QueryItems:
          Type: HttpApi
          Properties:
            Path: /items/{id}/answer
            Method: GET
            ApiId: !Ref FlashcardsApi
            Auth:
              Authorizer: CognitoAuthorizer
                   
  #
  # APP - Bucket
  #
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
        
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "${WebsiteBucket.Arn}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"
                
  #
  # APP - Cloudfront
  #
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AWS::StackName}-oac"
        Description: Access control for CloudFront to reach S3
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4
        
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Aliases:
          - !Ref DomainName
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        DefaultCacheBehavior:
          AllowedMethods: ["GET", "HEAD"]
          CachedMethods: ["GET", "HEAD"]
          TargetOriginId: s3Origin
          ViewerProtocolPolicy: redirect-to-https
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
        Origins:
          - Id: s3Origin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            S3OriginConfig: {}
            OriginAccessControlId: !Ref CloudFrontOAC
        CustomErrorResponses:
          # Flutter routing support
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html

  RootDomainRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront's fixed zone ID
        
Outputs:
  WebsiteBucketName:
    Description: "S3 bucket for Hugo site"
    Value: !Ref WebsiteBucket
    Export:
      Name: FlashcardWebAppBucketName
  CloudFrontDistribution:
    Description: "CloudFrontDistribution for Hugo site"
    Value: !Ref CloudFrontDistribution
    Export:
      Name: FlashcardWebAppCloudFrontDistribution
  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: FlashcardsCognitoUserPoolId
  CognitoUserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: FlashcardsCognitoUserPoolClientId
  CognitoUserPoolAWSRegion:
    Description: AWS Region where the Cognito is deployed
    Value: !Ref AWS::Region   
    Export:
      Name: FlashcardsCognitoAWSRegion
  FlashcardsApiEndpoint:
    Description: API Gateway base URL for Flashcards API
    Value: !Sub https://${FlashcardsApi}.execute-api.${AWS::Region}.amazonaws.com
    Export:
      Name: FlashcardsApiEndpoint
  FlashcardsApiRegion:
    Description: AWS Region for Flashcards API
    Value: !Ref AWS::Region
    Export:
      Name: FlashcardsApiRegion
